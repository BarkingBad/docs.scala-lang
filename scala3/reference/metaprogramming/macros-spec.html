<!DOCTYPE html>

<html class="scala3">

  <head>
    <title>
      Macros Spec | 
      Scala 3 Language Reference | 
      Scala Documentation
    </title>
    
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta property="og:site_name" content="Scala Documentation"/>
    <meta property="og:type" content="article"/>
    <meta property="og:url" content="http://0.0.0.0:4000/scala3/reference/metaprogramming/macros-spec.html"/>
    <meta property="og:image" content="http://0.0.0.0:4000/resources/img/scala-spiral-3d-2-toned-down.png"/>
    <meta property="og:title" content="Macros Spec"/>
    

    <meta name="twitter:card" content="summary"/>
    <meta name="twitter:site" content="@scala_lang"/>
    <meta name="twitter:creator" content="@scala_lang"/>
    <meta name="twitter:title" content="Macros Spec"/>
    

    <link rel="icon" type="image/png" href="resources/favicon.ico">
    <link rel="shortcut icon" type="image/png" href="resources/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="resources/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="resources/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="resources/favicon-16x16.png">
    <link rel="manifest" href="resources/site.webmanifest">
    <link rel="mask-icon" href="resources/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#15a9ce">
    <meta name="theme-color" content="#ffffff">

    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">

    <!-- Custom stylesheet -->
    <link href="resources/css/unslider-dots.css" rel="stylesheet" type="text/css">
    <link href="resources/css/unslider.css" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="resources/css/highlightjs.css" type="text/css" />
    <link rel="stylesheet" href="resources/css/style.css" type="text/css" />
    <link rel="stylesheet" href="resources/css/monospace.css" type="text/css" />

    <!-- Atom feeds -->
    <link rel="alternate" type="application/atom+xml" title="News Feed" href="http://scala-lang.org/feed/index.xml" />
    <link rel="alternate" type="application/atom+xml" title="Blog Feed" href="http://scala-lang.org/feed/blog.xml" />

    <!-- Algolia stylesheet -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" />


  </head>
  <body>





<div class="navigation-fade-screen"></div>



<header id="site-header">
  <div class="wrap">
    <nav class="navigation" role="menu">
      <a href="http://scala-lang.org" class="navigation-bdand">
        <img src="resources/img/frontpage/scala-logo-white@2x.png" alt="">
      </a>
      <div class="navigation-panel-button">
        <i class="fa fa-bars"></i>
      </div>
      <ul class="navigation-menu">
        
            <li class="navigation-menu-item">
              <a href="/" class="active">Documentation</a>
            </li>
        
            <li class="navigation-menu-item">
              <a href="https://www.scala-lang.org/download/" >Download</a>
            </li>
        
            <li class="navigation-menu-item">
              <a href="https://www.scala-lang.org/community/" >Community</a>
            </li>
        
            <li class="navigation-menu-item">
              <a href="https://index.scala-lang.org" >Libraries</a>
            </li>
        
            <li class="navigation-menu-item">
              <a href="https://www.scala-lang.org/contribute/" >Contribute</a>
            </li>
        
            <li class="navigation-menu-item">
              <a href="https://www.scala-lang.org/blog/" >Blog</a>
            </li>
        
      </ul>
    </nav>
  </div>
</header>



<header id="doc-header" class="scala3">

  <div class="wrap" style="padding: 0px;">
    <nav class="doc-navigation" role="menu">
      
      <div class="navigation-bdand">
      <a href="">
        <img src="resources/img/documentation-logo@2x.png" alt="docs">
      </a>
      <span class="doc-language-version">
        — Scala  3 
      </span>
      </div>
      <div class="navigation-ellipsis">
        <i class="fa fa-ellipsis-v"></i>
      </div>
      <ul class="navigation-menu">
        
            <li class="navigation-menu-item">
              
              
              <a href="#" id="learn" >Learn</a>
                
                <ul class="navigation-dropdown">
                
                  <li>
                    
                    
                    <a href="/scala3/new-in-scala3.html">New in Scala 3</a>
                  </li>
                
                  <li>
                    
                    
                    <a href="/scala3/getting-started.html">Getting Started</a>
                  </li>
                
                  <li>
                    
                    
                    <a href="/scala3/book/introduction.html">Scala 3 Book</a>
                  </li>
                
                  <li>
                    
                    
                    <a href="/scala3/guides/macros/index.html">Macro Tutorial</a>
                  </li>
                
                </ul>
                
            </li>
        
            <li class="navigation-menu-item">
              
              
              <a href="/scala3/guides/migration/compatibility-intro.html" id="migrate" >Migrate</a>
                
            </li>
        
            <li class="navigation-menu-item">
              
              
              <a href="/scala3/reference/overview.html" id="reference" >Reference</a>
                
            </li>
        
            <li class="navigation-menu-item">
              
              
              <a href="https://dotty.epfl.ch/api/index.html" id="api" >API</a>
                
            </li>
        
      </ul>
    </nav>
    <nav class="doc-navigation-submenus">
      
        
          <ul class="navigation-submenu" id="learn" style="display: none;">
            
              <li>
                <a href="/scala3/new-in-scala3.html">New in Scala 3</a>
              </li>
            
              <li>
                <a href="/scala3/getting-started.html">Getting Started</a>
              </li>
            
              <li>
                <a href="/scala3/book/introduction.html">Scala 3 Book</a>
              </li>
            
              <li>
                <a href="/scala3/guides/macros/index.html">Macro Tutorial</a>
              </li>
            
          </ul>
        
      
        
      
        
      
        
      
      <ul class="navigation-submenu ellipsis-menu" style="display: none;">
        
          
        
          
        
          
        
          
            <li><a href="https://dotty.epfl.ch/api/index.html">API</a></li>
          
        
      </ul>
    </nav>
  </div>
</header>


<main id="inner-main">
  <!-- Title -->
  <section class="title-page">
    <div class="wrap">
      <div class="content-title-documentation">
        
          <div class="wip-notice">
            <h4>Work in Progress</h4>
            <p>
              We are still in the process of writing the documentation for Scala 3.
              You can <a  href="/scala3/contribute-to-docs.html">help us</a> to improve the documentation.
            </p>
            <p>Are you searching for the <a href="/">Scala 2 documentation</a>?</p>
          </div>
        

        <div class="titles">
          
            <div class="supertitle">Scala 3 Language Reference</div>
          
          <h1>Macros Spec</h1>
        </div>
        <div class="language-dropdown">
          <div id="dd" class="wrapper-dropdown" tabindex="1">
            <span>Language</span>
              <ul class="dropdown"></ul>
          </div>
      </div>
    </div>
  </section>

  
  <section class="content">
	<div class="wrap">
		<div class="content-primary documentation">
			<div class="inner-box">
				<div class="toc-context">
					<h2 id="implementation">Implementation</h2>

<h3 id="syntax">Syntax</h3>

<p>Compared to the <a href="../syntax.html">Scala 3 reference grammar</a>
there are the following syntax changes:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SimpleExpr      ::=  ...
                  |  ‘'’ ‘{’ Block ‘}’
                  |  ‘'’ ‘[’ Type ‘]’
                  |  ‘$’ ‘{’ Block ‘}’
SimpleType      ::=  ...
                  |  ‘$’ ‘{’ Block ‘}’
</code></pre></div></div>
<p>In addition, an identifier <code class="language-plaintext highlighter-rouge">$x</code> starting with a <code class="language-plaintext highlighter-rouge">$</code> that appears inside
a quoted expression or type is treated as a splice <code class="language-plaintext highlighter-rouge">${x}</code> and a quoted identifier
<code class="language-plaintext highlighter-rouge">'x</code> that appears inside a splice is treated as a quote <code class="language-plaintext highlighter-rouge">'{x}</code></p>

<h3 id="implementation-in-scalac">Implementation in <code class="language-plaintext highlighter-rouge">scalac</code></h3>

<p>Quotes and splices are primitive forms in the generated abstract syntax trees.
Top-level splices are eliminated during macro expansion while typing. On the
other hand, top-level quotes are eliminated in an expansion phase <code class="language-plaintext highlighter-rouge">PickleQuotes</code>
phase (after typing and pickling). PCP checking occurs while preparing the RHS
of an inline method for top-level splices and in the <code class="language-plaintext highlighter-rouge">Staging</code> phase (after
typing and before pickling).</p>

<p>Macro-expansion works outside-in. If the outermost scope is a splice,
the spliced AST will be evaluated in an interpreter. A call to a
previously compiled method can be implemented as a reflective call to
that method. With the restrictions on splices that are currently in
place that’s all that’s needed. We might allow more interpretation in
splices in the future, which would allow us to loosen the
restriction.  Quotes in spliced, interpreted code are kept as they
are, after splices nested in the quotes are expanded.</p>

<p>If the outermost scope is a quote, we need to generate code that
constructs the quoted tree at run-time. We implement this by
serializing the tree as a TASTy structure, which is stored
in a string literal. At runtime, an unpickler method is called to
deserialize the string into a tree.</p>

<p>Splices inside quoted code insert the spliced tree as is, after
expanding any quotes in the spliced code recursively.</p>

<h2 id="formalization">Formalization</h2>

<p>The phase consistency principle can be formalized in a calculus that
extends simply-typed lambda calculus with quotes and splices.</p>

<h3 id="syntax-1">Syntax</h3>

<p>The syntax of terms, values, and types is given as follows:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Terms         t  ::=  x                 variable
                      (x: T) =&gt; t       lambda
                      t t               application
                      't                quote
                      $t                splice

Values        v  ::=  (x: T) =&gt; t       lambda
                      'u                quote

Simple terms  u  ::=  x  |  (x: T) =&gt; u  |  u u  |  't

Types         T  ::=  A                 base type
                      T -&gt; T            function type
                      expr T            quoted
</code></pre></div></div>
<p>Typing rules are formulated using a stack of environments
<code class="language-plaintext highlighter-rouge">Es</code>. Individual environments <code class="language-plaintext highlighter-rouge">E</code> consist as usual of variable
bindings <code class="language-plaintext highlighter-rouge">x: T</code>. Environments can be combined using the two
combinators <code class="language-plaintext highlighter-rouge">'</code> and <code class="language-plaintext highlighter-rouge">$</code>.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Environment   E  ::=  ()                empty
                      E, x: T

Env. stack    Es ::=  ()                empty
                      E                 simple
                      Es * Es           combined

Separator     *  ::=  '
                      $
</code></pre></div></div>
<p>The two environment combinators are both associative with left and
right identity <code class="language-plaintext highlighter-rouge">()</code>.</p>

<h3 id="operational-semantics">Operational semantics</h3>

<p>We define a small step reduction relation <code class="language-plaintext highlighter-rouge">--&gt;</code> with the following rules:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>          ((x: T) =&gt; t) v  --&gt;  [x := v]t

                    ${'u}  --&gt;  u

                       t1  --&gt;  t2
                    -----------------
                    e[t1]  --&gt;  e[t2]
</code></pre></div></div>
<p>The first rule is standard call-by-value beta-reduction. The second
rule says that splice and quotes cancel each other out. The third rule
is a context rule; it says that reduction is allowed in the hole <code class="language-plaintext highlighter-rouge">[ ]</code>
position of an evaluation context.  Evaluation contexts <code class="language-plaintext highlighter-rouge">e</code> and
splice evaluation context <code class="language-plaintext highlighter-rouge">e_s</code> are defined syntactically as follows:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Eval context    e    ::=  [ ]  |  e t  |  v e  |  'e_s[${e}]
Splice context  e_s  ::=  [ ]  |  (x: T) =&gt; e_s  |  e_s t  |  u e_s
</code></pre></div></div>

<h3 id="typing-rules">Typing rules</h3>

<p>Typing judgments are of the form <code class="language-plaintext highlighter-rouge">Es |- t: T</code>. There are two
substructural rules which express the fact that quotes and splices
cancel each other out:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>                    Es1 * Es2 |- t: T
               ---------------------------
               Es1 $ E1 ' E2 * Es2 |- t: T


                    Es1 * Es2 |- t: T
               ---------------------------
               Es1 ' E1 $ E2 * Es2 |- t: T
</code></pre></div></div>
<p>The lambda calculus fragment of the rules is standard, except that we
use a stack of environments. The rules only interact with the topmost
environment of the stack.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>                          x: T in E
                        --------------
                        Es * E |- x: T


                    Es * E, x: T1 |- t: T2
                -------------------------------
                Es * E |- (x: T1) =&gt; t: T -&gt; T2


               Es |- t1: T2 -&gt; T    Es |- t2: T2
               ---------------------------------
                      Es |- t1 t2: T
</code></pre></div></div>
<p>The rules for quotes and splices map between <code class="language-plaintext highlighter-rouge">expr T</code> and <code class="language-plaintext highlighter-rouge">T</code> by trading <code class="language-plaintext highlighter-rouge">'</code> and <code class="language-plaintext highlighter-rouge">$</code> between
environments and terms.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>                     Es $ () |- t: expr T
                     --------------------
                         Es |- $t: T


                       Es ' () |- t: T
                       ----------------
                       Es |- 't: expr T
</code></pre></div></div>
<p>The meta theory of a slightly simplified 2-stage variant of this calculus
is studied <a href="./simple-smp.html">separately</a>.</p>

<h2 id="going-further">Going Further</h2>

<p>The metaprogramming framework as presented and currently implemented is quite restrictive
in that it does not allow for the inspection of quoted expressions and
types. It’s possible to work around this by providing all necessary
information as normal, unquoted inline parameters. But we would gain
more flexibility by allowing for the inspection of quoted code with
pattern matching. This opens new possibilities.</p>

<p>For instance, here is a version of <code class="language-plaintext highlighter-rouge">power</code> that generates the multiplications
directly if the exponent is statically known and falls back to the dynamic
implementation of <code class="language-plaintext highlighter-rouge">power</code> otherwise.</p>
<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">scala.quoted.</span><span class="o">*</span>

<span class="n">inline</span> <span class="k">def</span> <span class="nf">power</span><span class="o">(</span><span class="n">x</span><span class="k">:</span> <span class="kt">Double</span><span class="o">,</span> <span class="n">n</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Double</span> <span class="o">=</span>
  <span class="n">$</span><span class="o">{</span> <span class="nf">powerExpr</span><span class="o">(</span><span class="ss">'x</span><span class="o">,</span> <span class="ss">'n</span><span class="o">)</span> <span class="o">}</span>

<span class="k">private</span> <span class="k">def</span> <span class="nf">powerExpr</span><span class="o">(</span><span class="n">x</span><span class="k">:</span> <span class="kt">Expr</span><span class="o">[</span><span class="kt">Double</span><span class="o">],</span> <span class="n">n</span><span class="k">:</span> <span class="kt">Expr</span><span class="o">[</span><span class="kt">Int</span><span class="o">])</span>
                     <span class="o">(</span><span class="n">using</span> <span class="nc">Quotes</span><span class="o">)</span><span class="k">:</span> <span class="kt">Expr</span><span class="o">[</span><span class="kt">Double</span><span class="o">]</span> <span class="k">=</span>
  <span class="nv">n</span><span class="o">.</span><span class="py">value</span> <span class="k">match</span>
    <span class="k">case</span> <span class="nc">Some</span><span class="o">(</span><span class="n">m</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nf">powerExpr</span><span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">m</span><span class="o">)</span>
    <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="o">'{</span> <span class="nf">dynamicPower</span><span class="o">(</span><span class="nc">$x</span><span class="o">,</span> <span class="nc">$n</span><span class="o">)</span> <span class="o">}</span>

<span class="k">private</span> <span class="k">def</span> <span class="nf">powerExpr</span><span class="o">(</span><span class="n">x</span><span class="k">:</span> <span class="kt">Expr</span><span class="o">[</span><span class="kt">Double</span><span class="o">],</span> <span class="n">n</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span>
                     <span class="o">(</span><span class="n">using</span> <span class="nc">Quotes</span><span class="o">)</span><span class="k">:</span> <span class="kt">Expr</span><span class="o">[</span><span class="kt">Double</span><span class="o">]</span> <span class="k">=</span>
  <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span> <span class="n">then</span> <span class="o">'{</span> <span class="mf">1.0</span> <span class="o">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span> <span class="n">then</span> <span class="n">x</span>
  <span class="k">else</span> <span class="k">if</span> <span class="n">n</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span> <span class="n">then</span> <span class="o">'{</span> <span class="k">val</span> <span class="nv">y</span> <span class="k">=</span> <span class="nc">$x</span> <span class="o">*</span> <span class="nc">$x</span><span class="o">;</span> <span class="n">$</span><span class="o">{</span> <span class="nf">powerExpr</span><span class="o">(</span><span class="ss">'y</span><span class="o">,</span> <span class="n">n</span> <span class="o">/</span> <span class="mi">2</span><span class="o">)</span> <span class="o">}</span> <span class="o">}</span>
  <span class="k">else</span> <span class="o">'{</span> <span class="nc">$x</span> <span class="o">*</span> <span class="n">$</span><span class="o">{</span> <span class="nf">powerExpr</span><span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="o">}</span> <span class="o">}</span>

<span class="k">private</span> <span class="k">def</span> <span class="nf">dynamicPower</span><span class="o">(</span><span class="n">x</span><span class="k">:</span> <span class="kt">Double</span><span class="o">,</span> <span class="n">n</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Double</span> <span class="o">=</span>
  <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span> <span class="n">then</span> <span class="mf">1.0</span>
  <span class="k">else</span> <span class="k">if</span> <span class="n">n</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span> <span class="n">then</span> <span class="nf">dynamicPower</span><span class="o">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">x</span><span class="o">,</span> <span class="n">n</span> <span class="o">/</span> <span class="mi">2</span><span class="o">)</span>
  <span class="k">else</span> <span class="n">x</span> <span class="o">*</span> <span class="nf">dynamicPower</span><span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span>
</code></pre></div></div>

<p>In the above, the method <code class="language-plaintext highlighter-rouge">.value</code> maps a constant expression of the type
<code class="language-plaintext highlighter-rouge">Expr[T]</code> to its value of the type <code class="language-plaintext highlighter-rouge">T</code>.</p>

<p>With the right extractors, the “AsFunction” conversion
that maps expressions over functions to functions over expressions can
be implemented in user code:</p>
<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">given</span> <span class="nc">AsFunction1</span><span class="o">[</span><span class="kt">T</span>, <span class="kt">U</span><span class="o">]</span><span class="k">:</span> <span class="kt">Conversion</span><span class="o">[</span><span class="kt">Expr</span><span class="o">[</span><span class="kt">T</span> <span class="k">=&gt;</span> <span class="kt">U</span><span class="o">]</span>, <span class="kt">Expr</span><span class="o">[</span><span class="kt">T</span><span class="o">]</span> <span class="k">=&gt;</span> <span class="kt">Expr</span><span class="o">[</span><span class="kt">U</span><span class="o">]]</span> <span class="k">with</span>
  <span class="k">def</span> <span class="nf">apply</span><span class="o">(</span><span class="n">f</span><span class="k">:</span> <span class="kt">Expr</span><span class="o">[</span><span class="kt">T</span> <span class="k">=&gt;</span> <span class="kt">U</span><span class="o">])</span><span class="k">:</span> <span class="kt">Expr</span><span class="o">[</span><span class="kt">T</span><span class="o">]</span> <span class="k">=&gt;</span> <span class="nc">Expr</span><span class="o">[</span><span class="kt">U</span><span class="o">]</span> <span class="k">=</span>
    <span class="o">(</span><span class="n">x</span><span class="k">:</span> <span class="kt">Expr</span><span class="o">[</span><span class="kt">T</span><span class="o">])</span> <span class="k">=&gt;</span> <span class="n">f</span> <span class="k">match</span>
      <span class="k">case</span> <span class="nc">Lambda</span><span class="o">(</span><span class="n">g</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nf">g</span><span class="o">(</span><span class="n">x</span><span class="o">)</span>
      <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="o">'{</span> <span class="o">(</span><span class="nc">$f</span><span class="o">)(</span><span class="nc">$x</span><span class="o">)</span> <span class="o">}</span>
</code></pre></div></div>
<p>This assumes an extractor</p>
<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">object</span> <span class="nc">Lambda</span><span class="k">:</span>
  <span class="kt">def</span> <span class="kt">unapply</span><span class="o">[</span><span class="kt">T</span>, <span class="kt">U</span><span class="o">](</span><span class="n">x</span><span class="k">:</span> <span class="kt">Expr</span><span class="o">[</span><span class="kt">T</span> <span class="k">=&gt;</span> <span class="kt">U</span><span class="o">])</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">Expr</span><span class="o">[</span><span class="kt">T</span><span class="o">]</span> <span class="k">=&gt;</span> <span class="kt">Expr</span><span class="o">[</span><span class="kt">U</span><span class="o">]]</span>
</code></pre></div></div>
<p>Once we allow inspection of code via extractors, it’s tempting to also
add constructors that create typed trees directly without going
through quotes. Most likely, those constructors would work over <code class="language-plaintext highlighter-rouge">Expr</code>
types which lack a known type argument. For instance, an <code class="language-plaintext highlighter-rouge">Apply</code>
constructor could be typed as follows:</p>
<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">Apply</span><span class="o">(</span><span class="n">fn</span><span class="k">:</span> <span class="kt">Expr</span><span class="o">[</span><span class="kt">Any</span><span class="o">],</span> <span class="n">args</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">Expr</span><span class="o">[</span><span class="kt">Any</span><span class="o">]])</span><span class="k">:</span> <span class="kt">Expr</span><span class="o">[</span><span class="kt">Any</span><span class="o">]</span>
</code></pre></div></div>
<p>This would allow constructing applications from lists of arguments
without having to match the arguments one-by-one with the
corresponding formal parameter types of the function. We then need “at
the end” a method to convert an <code class="language-plaintext highlighter-rouge">Expr[Any]</code> to an <code class="language-plaintext highlighter-rouge">Expr[T]</code> where <code class="language-plaintext highlighter-rouge">T</code> is
given from the outside. For instance, if <code class="language-plaintext highlighter-rouge">code</code> yields a <code class="language-plaintext highlighter-rouge">Expr[Any]</code>, then
<code class="language-plaintext highlighter-rouge">code.atType[T]</code> yields an <code class="language-plaintext highlighter-rouge">Expr[T]</code>. The <code class="language-plaintext highlighter-rouge">atType</code> method has to be
implemented as a primitive; it would check that the computed type
structure of <code class="language-plaintext highlighter-rouge">Expr</code> is a subtype of the type structure representing
<code class="language-plaintext highlighter-rouge">T</code>.</p>

<p>Before going down that route, we should evaluate in detail the tradeoffs it
presents. Constructing trees that are only verified <em>a posteriori</em>
to be type correct loses a lot of guidance for constructing the right
trees.  So we should wait with this addition until we have more
use-cases that help us decide whether the loss in type-safety is worth
the gain in flexibility. In this context, it seems that deconstructing types is
less error-prone than deconstructing terms, so one might also
envisage a solution that allows the former but not the latter.</p>

<h2 id="conclusion">Conclusion</h2>

<p>Metaprogramming has a reputation of being difficult and confusing.
But with explicit <code class="language-plaintext highlighter-rouge">Expr/Type</code> types and quotes and splices it can become
downright pleasant. A simple strategy first defines the underlying quoted or unquoted
values using <code class="language-plaintext highlighter-rouge">Expr</code> and <code class="language-plaintext highlighter-rouge">Type</code> and then inserts quotes and splices to make the types
line up. Phase consistency is at the same time a great guideline
where to insert a splice or a quote and a vital sanity check that
the result makes sense.</p>

				</div>

				<div class="content-contributors">
    <h3>Contributors to this page:</h3>
    <div id="contributors" class="contributors-container"></div>
</div>

			</div>
		</div>

		<!-- TOC -->
		<div class="content-nav">
	<div class="inner-box sidebar-toc-wrapper" style="">
		<h5 class="contents">Contents</h5>
		<div class="inner-toc" id="sidebar-toc">
      <div id="toc"></div>
      
		</div>
		<hr>
		<div class="help-us"><a href="https://github.com/scala/docs.scala-lang/blob/main/_scala3-reference/metaprogramming/macros-spec.md"><i class="fa fa-pencil" aria-hidden="true"></i> Problem with this page?<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Please help us fix it!</a></div>
	</div>
</div>

	</div>
</section>


</main>

<footer id="site-footer">
    <div class="wrap">
      <div class="site-footer-top">
        
          <ul class="documentation">
            <li><h3>Documentation</h3></li>
            
              <li><a href="/getting-started.html">Getting Started</a></li>
            
              <li><a href="https://www.scala-lang.org/api/current/index.html">API</a></li>
            
              <li><a href="/overviews">Overviews/Guides</a></li>
            
              <li><a href="http://scala-lang.org/files/archive/spec/2.13/">Language Specification</a></li>
            
          </ul>
        
          <ul class="download">
            <li><h3>Download</h3></li>
            
              <li><a href="http://scala-lang.org/download/">Current Version</a></li>
            
              <li><a href="http://scala-lang.org/download/all.html">All versions</a></li>
            
          </ul>
        
          <ul class="community">
            <li><h3>Community</h3></li>
            
              <li><a href="http://scala-lang.org/community/">Community</a></li>
            
              <li><a href="http://scala-lang.org/community/index.html#mailing-lists">Mailing Lists</a></li>
            
              <li><a href="http://scala-lang.org/community/index.html#chat-rooms">Chat Rooms & More</a></li>
            
              <li><a href="http://scala-lang.org/community/index.html#community-libraries-and-tools">Libraries and Tools</a></li>
            
              <li><a href="http://scala.epfl.ch/">The Scala Center</a></li>
            
          </ul>
        
          <ul class="contribute">
            <li><h3>Contribute</h3></li>
            
              <li><a href="http://scala-lang.org/contribute/">How to help</a></li>
            
              <li><a href="http://scala-lang.org/contribute/bug-reporting-guide.html">Report an Issue</a></li>
            
          </ul>
        
          <ul class="scala">
            <li><h3>Scala</h3></li>
            
              <li><a href="http://scala-lang.org/blog/">Blog</a></li>
            
              <li><a href="http://scala-lang.org/conduct/">Code of Conduct</a></li>
            
              <li><a href="http://scala-lang.org/license/">License</a></li>
            
          </ul>
        
          <ul class="social">
            <li><h3>Social</h3></li>
            
              <li><a href="https://github.com/scala/scala">GitHub</a></li>
            
              <li><a href="https://twitter.com/scala_lang">Twitter</a></li>
            
          </ul>
        
      </div>
      <div class="site-footer-bottom">
        <p></p>
        <img src="resources/img/frontpage/scala-logo-white.png" alt="">
      </div>
    </div>
    <a class="back-to-top in" href="#" id="scroll-to-top-btn">
      <i class="fa fa-angle-up"></i>
    </a>
</footer>

<!-- jquery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js" integrity="sha384-3ceskX3iaEnIogmQchP8opvBy3Mi7Ce34nWjpBIwVTHfGYWQS9jwHDVRnpKKHJg7" crossorigin="anonymous"></script>
<script>(window.jQuery) || document.write('<script src="scripts/jquery-3.1.1.min.js"><\/script>');</script>
<script src="resources/js/vendor/jquery.autocomplete.js" type="text/javascript"></script>



<script src="scripts/searchbar.js" type="text/javascript"></script>
<link rel="stylesheet" href="scripts/my.css" type="text/css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.9.0/css/all.min.css">

<!-- moment js -->
<script src="resources/js/vendor/moment.min.js" type="text/javascript"></script>

<!-- tweet feed -->
<script src="resources/js/tweetMachine-update.js" type="text/javascript"></script>

<!-- prettify js -->
<script src="resources/js/vendor/prettify/prettify.js" type="text/javascript"></script>
<script src="resources/js/vendor/prettify/lang-scala.js" type="text/javascript"></script>

<!-- unslider js -->
<script src="resources/js/vendor/unslider.js" type="text/javascript"></script>

<!-- Highlight -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/highlight.min.js" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/languages/scala.min.js" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/languages/java.min.js" type="text/javascript"></script>

<!-- CodeMirror -->
<script src="resources/js/vendor/codemirror/codemirror.js" type="text/javascript"></script>
<script src="resources/js/vendor/codemirror/clike.js" type="text/javascript"></script>

<!-- TOC -->
<script src="resources/js/vendor/toc.js" type="text/javascript"></script>

<!-- Blog search -->
<script src="resources/js/vendor/jekyll.search.min.js" type="text/javascript"></script>

<!-- Custom JavaScript -->
<script src="resources/js/functions.js" type="text/javascript"></script>



<!-- Alogolia search for doc -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
<script type="text/javascript">
if ($("#doc-search-bar").length) {
  docsearch({
    apiKey: 'fbc439670f5d4e3730cdcb715c359391',
    indexName: 'scala-lang',
    inputSelector: '#doc-search-bar',
    algoliaOptions: { 'facetFilters': ["language:en"] },
    debug: false // Set debug to true if you want to inspect the dropdown
  });
}
</script>
</body>

</html>

