<!DOCTYPE html>

<html class="scala3">

  <head>
    <title>
      CanThrow Abilities | 
      Scala 3 Language Reference | 
      Scala Documentation
    </title>
    
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta property="og:site_name" content="Scala Documentation"/>
    <meta property="og:type" content="article"/>
    <meta property="og:url" content="http://0.0.0.0:4000/scala3/reference/experimental/canthrow.html"/>
    <meta property="og:image" content="http://0.0.0.0:4000/resources/img/scala-spiral-3d-2-toned-down.png"/>
    <meta property="og:title" content="CanThrow Abilities"/>
    

    <meta name="twitter:card" content="summary"/>
    <meta name="twitter:site" content="@scala_lang"/>
    <meta name="twitter:creator" content="@scala_lang"/>
    <meta name="twitter:title" content="CanThrow Abilities"/>
    

    <link rel="icon" type="image/png" href="/docs.scala-lang/resources/favicon.ico">
    <link rel="shortcut icon" type="image/png" href="/docs.scala-lang/resources/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="/docs.scala-lang/resources/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/docs.scala-lang/resources/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/docs.scala-lang/resources/favicon-16x16.png">
    <link rel="manifest" href="/docs.scala-lang/resources/site.webmanifest">
    <link rel="mask-icon" href="/docs.scala-lang/resources/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#15a9ce">
    <meta name="theme-color" content="#ffffff">

    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">

    <!-- Custom stylesheet -->
    <link href="/docs.scala-lang/resources/css/unslider-dots.css" rel="stylesheet" type="text/css">
    <link href="/docs.scala-lang/resources/css/unslider.css" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="/docs.scala-lang/resources/css/highlightjs.css" type="text/css" />
    <link rel="stylesheet" href="/docs.scala-lang/resources/css/style.css" type="text/css" />
    <link rel="stylesheet" href="/docs.scala-lang/resources/css/monospace.css" type="text/css" />

    <!-- Atom feeds -->
    <link rel="alternate" type="application/atom+xml" title="News Feed" href="http://scala-lang.org/feed/index.xml" />
    <link rel="alternate" type="application/atom+xml" title="Blog Feed" href="http://scala-lang.org/feed/blog.xml" />

    <!-- Algolia stylesheet -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" />


  </head>
  <body>





<div class="navigation-fade-screen"></div>



<header id="site-header">
  <div class="wrap">
    <nav class="navigation" role="menu">
      <a href="http://scala-lang.org" class="navigation-bdand">
        <img src="/docs.scala-lang/resources/img/frontpage/scala-logo-white@2x.png" alt="">
      </a>
      <div class="navigation-panel-button">
        <i class="fa fa-bars"></i>
      </div>
      <ul class="navigation-menu">
        
            <li class="navigation-menu-item">
              <a href="/docs.scala-lang/" class="active">Documentation</a>
            </li>
        
            <li class="navigation-menu-item">
              <a href="https://www.scala-lang.org/download/" >Download</a>
            </li>
        
            <li class="navigation-menu-item">
              <a href="https://www.scala-lang.org/community/" >Community</a>
            </li>
        
            <li class="navigation-menu-item">
              <a href="https://index.scala-lang.org" >Libraries</a>
            </li>
        
            <li class="navigation-menu-item">
              <a href="https://www.scala-lang.org/contribute/" >Contribute</a>
            </li>
        
            <li class="navigation-menu-item">
              <a href="https://www.scala-lang.org/blog/" >Blog</a>
            </li>
        
      </ul>
    </nav>
  </div>
</header>



<header id="doc-header" class="scala3">

  <div class="wrap" style="padding: 0px;">
    <nav class="doc-navigation" role="menu">
      
      <div class="navigation-bdand">
      <a href="/docs.scala-lang/">
        <img src="/docs.scala-lang/resources/img/documentation-logo@2x.png" alt="docs">
      </a>
      <span class="doc-language-version">
        — Scala  3 
      </span>
      </div>
      <div class="navigation-ellipsis">
        <i class="fa fa-ellipsis-v"></i>
      </div>
      <ul class="navigation-menu">
        
            <li class="navigation-menu-item">
              
              
              <a href="#" id="learn" >Learn</a>
                
                <ul class="navigation-dropdown">
                
                  <li>
                    
                    
                    <a href="/docs.scala-lang/scala3/new-in-scala3.html">New in Scala 3</a>
                  </li>
                
                  <li>
                    
                    
                    <a href="/docs.scala-lang/scala3/getting-started.html">Getting Started</a>
                  </li>
                
                  <li>
                    
                    
                    <a href="/docs.scala-lang/scala3/book/introduction.html">Scala 3 Book</a>
                  </li>
                
                  <li>
                    
                    
                    <a href="/docs.scala-lang/scala3/guides/macros/index.html">Macro Tutorial</a>
                  </li>
                
                </ul>
                
            </li>
        
            <li class="navigation-menu-item">
              
              
              <a href="/docs.scala-lang/scala3/guides/migration/compatibility-intro.html" id="migrate" >Migrate</a>
                
            </li>
        
            <li class="navigation-menu-item">
              
              
              <a href="/docs.scala-lang/scala3/reference/overview.html" id="reference" >Reference</a>
                
            </li>
        
            <li class="navigation-menu-item">
              
              
              <a href="https://dotty.epfl.ch/api/index.html" id="api" >API</a>
                
            </li>
        
      </ul>
    </nav>
    <nav class="doc-navigation-submenus">
      
        
          <ul class="navigation-submenu" id="learn" style="display: none;">
            
              <li>
                <a href="/docs.scala-lang/scala3/new-in-scala3.html">New in Scala 3</a>
              </li>
            
              <li>
                <a href="/docs.scala-lang/scala3/getting-started.html">Getting Started</a>
              </li>
            
              <li>
                <a href="/docs.scala-lang/scala3/book/introduction.html">Scala 3 Book</a>
              </li>
            
              <li>
                <a href="/docs.scala-lang/scala3/guides/macros/index.html">Macro Tutorial</a>
              </li>
            
          </ul>
        
      
        
      
        
      
        
      
      <ul class="navigation-submenu ellipsis-menu" style="display: none;">
        
          
        
          
        
          
        
          
            <li><a href="https://dotty.epfl.ch/api/index.html">API</a></li>
          
        
      </ul>
    </nav>
  </div>
</header>


<main id="inner-main">
  <!-- Title -->
  <section class="title-page">
    <div class="wrap">
      <div class="content-title-documentation">
        
          <div class="wip-notice">
            <h4>Work in Progress</h4>
            <p>
              We are still in the process of writing the documentation for Scala 3.
              You can <a  href="/scala3/contribute-to-docs.html">help us</a> to improve the documentation.
            </p>
            <p>Are you searching for the <a href="/">Scala 2 documentation</a>?</p>
          </div>
        

        <div class="titles">
          
            <div class="supertitle">Scala 3 Language Reference</div>
          
          <h1>CanThrow Abilities</h1>
        </div>
        <div class="language-dropdown">
          <div id="dd" class="wrapper-dropdown" tabindex="1">
            <span>Language</span>
              <ul class="dropdown"></ul>
          </div>
      </div>
    </div>
  </section>

  
  <section class="content">
	<div class="wrap">
		<div class="content-primary documentation">
			<div class="inner-box">
				<div class="toc-context">
					<p>This page describes experimental support for exception checking in Scala 3. It is enabled by the language import</p>
<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">language.experimental.saferExceptions</span>
</code></pre></div></div>
<p>The reason for publishing this extension now is to get feedback on its usability. We are working on more advanced type systems that build on the general ideas put forward in the extension. Those type systems have application areas beyond checked exceptions. Exception checking is a useful starting point since exceptions are familiar to all Scala programmers and their current treatment leaves room for improvement.</p>

<h2 id="why-exceptions">Why Exceptions?</h2>

<p>Exceptions are an ideal mechanism for error handling in many situations. They serve the intended purpose of propagating error conditions with a minimum of boilerplate. They cause zero overhead for the “happy path”, which means they are very efficient as long as errors arise infrequently. Exceptions are also debug friendly, since they produce stack traces that can be inspected at the handler site. So one never has to guess where an erroneous condition originated.</p>

<h2 id="why-not-exceptions">Why Not Exceptions?</h2>

<p>However, exceptions in current Scala and many other languages are not reflected in the type system. This means that an essential part of the contract of a function - i.e. what exceptions can it produce? - is not statically checked. Most people acknowledge that this is a problem, but that so far the alternative of checked exceptions was just too painful to be considered. A good example are Java checked exceptions, which do the right thing in principle, but are widely regarded as a mistake since they are so difficult to deal with. So far, none of the successor languages that are modeled after Java or that build on the JVM has copied this feature. See for example Anders Hejlsberg’s <a href="https://www.artima.com/articles/the-trouble-with-checked-exceptions">statement on why C# does not have checked exceptions</a>.</p>

<h2 id="the-problem-with-javas-checked-exceptions">The Problem With Java’s Checked Exceptions</h2>

<p>The main problem with Java’s checked exception model is its inflexibility, which is due to lack of polymorphism. Consider for instance the <code class="language-plaintext highlighter-rouge">map</code> function which is declared on <code class="language-plaintext highlighter-rouge">List[A]</code> like this:</p>
<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">def</span> <span class="nf">map</span><span class="o">[</span><span class="kt">B</span><span class="o">](</span><span class="n">f</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=&gt;</span> <span class="n">B</span><span class="o">)</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">B</span><span class="o">]</span>
</code></pre></div></div>
<p>In the Java model, function <code class="language-plaintext highlighter-rouge">f</code> is not allowed to throw a checked exception. So the following call would be invalid:</p>
<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nv">xs</span><span class="o">.</span><span class="py">map</span><span class="o">(</span><span class="n">x</span> <span class="k">=&gt;</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">limit</span> <span class="n">then</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x</span> <span class="k">else</span> <span class="k">throw</span> <span class="nc">LimitExceeded</span><span class="o">())</span>
</code></pre></div></div>
<p>The only way around this would be to wrap the checked exception <code class="language-plaintext highlighter-rouge">LimitExceeded</code> in an unchecked <code class="language-plaintext highlighter-rouge">RuntimeException</code> that is caught at the callsite and unwrapped again. Something like this:</p>
<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">try</span>
    <span class="nv">xs</span><span class="o">.</span><span class="py">map</span><span class="o">(</span><span class="n">x</span> <span class="k">=&gt;</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">limit</span> <span class="n">then</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x</span> <span class="k">else</span> <span class="k">throw</span> <span class="nc">Wrapper</span><span class="o">(</span><span class="nc">LimitExceeded</span><span class="o">()))</span>
  <span class="k">catch</span> <span class="k">case</span> <span class="nc">Wrapper</span><span class="o">(</span><span class="n">ex</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="k">throw</span> <span class="n">ex</span>
</code></pre></div></div>
<p>Ugh! No wonder checked exceptions in Java are not very popular.</p>

<h2 id="monadic-effects">Monadic Effects</h2>

<p>So the dilemma is that exceptions are easy to use only as long as we forgo static type checking. This has caused many people working with Scala to abandon exceptions altogether and to use an error monad like <code class="language-plaintext highlighter-rouge">Either</code> instead. This can work in many situations but is not without its downsides either. It makes code a lot more complicated and harder to refactor. It means one is quickly confronted with the problem how to work with several monads. In general, dealing with one monad at a time in Scala is straightforward but dealing with several monads together is much less pleasant since monads don’t compose. A great number of techniques have been proposed, implemented, and promoted to deal with this, from monad transformers, to free monads, to tagless final. But none of these techniques is universally liked;  each introduces a complicated DSL that’s hard to understand for non-experts, introduces runtime overheads, and makes debugging difficult. In the end, quite a few developers prefer to work instead with a single “super-monad” like ZIO that has error propagation built in alongside other aspects. This one-size fits all approach can work very nicely, even though (or is it because?) it represents an all-encompassing framework.</p>

<p>However, a programming language is not a framework; it has to cater also for those applications that do not fit the framework’s use cases. So there’s still a strong motivation for getting exception checking right.</p>

<h2 id="from-effects-to-abilities">From Effects To Abilities</h2>

<p>Why does <code class="language-plaintext highlighter-rouge">map</code> work so poorly with Java’s checked exception model? It’s because
<code class="language-plaintext highlighter-rouge">map</code>’s signature limits function arguments to not throw checked exceptions. We could try to come up with a more polymorphic formulation of <code class="language-plaintext highlighter-rouge">map</code>. For instance, it could look like this:</p>
<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">def</span> <span class="nf">map</span><span class="o">[</span><span class="kt">B</span>, <span class="kt">E</span><span class="o">](</span><span class="n">f</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=&gt;</span> <span class="n">B</span> <span class="n">canThrow</span> <span class="n">E</span><span class="o">)</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">B</span><span class="o">]</span> <span class="n">canThrow</span> <span class="n">E</span>
</code></pre></div></div>
<p>This assumes a type <code class="language-plaintext highlighter-rouge">A canThrow E</code> to indicate computations of type <code class="language-plaintext highlighter-rouge">A</code> that can throw an exception of type <code class="language-plaintext highlighter-rouge">E</code>. But in practice the overhead of the additional type parameters makes this approach unappealing as well. Note in particular that we’d have to parameterize <em>every method</em> that takes a function argument that way, so the added overhead of declaring all these exception types looks just like a sort of ceremony we would like to avoid.</p>

<p>But there is a way to avoid the ceremony. Instead of concentrating on possible <em>effects</em> such as “this code might throw an exception”, concentrate on <em>capabilities</em> such as “this code needs the capability to throw an exception”. From a standpoint of expressiveness this is quite similar. But capabilities can be expressed as parameters whereas traditionally effects are expressed as some addition to result values. It turns out that this can make a big difference!</p>

<p>Going to the root of the word <em>capability</em>, it means “being <em>able</em> to do something”, so the “cap” prefix is really just a filler. Following Conor McBride, we will use the name <em>ability</em> from now on.</p>

<h2 id="the-canthrow-ability">The CanThrow Ability</h2>

<p>In the <em>effects as abilities</em> model, an effect is expressed as an (implicit) parameter of a certain type. For exceptions we would expect parameters of type
<code class="language-plaintext highlighter-rouge">CanThrow[E]</code> where <code class="language-plaintext highlighter-rouge">E</code> stands for the exception that can be thrown. Here is the definition of <code class="language-plaintext highlighter-rouge">CanThrow</code>:</p>
<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">erased</span> <span class="k">class</span> <span class="nc">CanThrow</span><span class="o">[</span><span class="kt">-E</span> <span class="k">&lt;:</span> <span class="kt">Exception</span><span class="o">]</span>
</code></pre></div></div>
<p>This shows another experimental Scala feature: <a href="/scala3/reference/experimental/erased-defs.html">erased definitions</a>. Roughly speaking, values of an erased class do not generate runtime code; they are erased before code generation. This means that all <code class="language-plaintext highlighter-rouge">CanThrow</code> abilities are compile-time only artifacts; they do not have a runtime footprint.</p>

<p>Now, if the compiler sees a <code class="language-plaintext highlighter-rouge">throw Exc()</code> construct where <code class="language-plaintext highlighter-rouge">Exc</code> is a checked exception, it will check that there is an ability of type <code class="language-plaintext highlighter-rouge">CanThrow[Exc]</code> that can be summoned as a given. It’s a compile-time error if that’s not the case.</p>

<p>How can the ability be produced? There are several possibilities:</p>

<p>Most often, the ability is produced by having a using clause <code class="language-plaintext highlighter-rouge">(using CanThrow[Exc])</code> in some enclosing scope. This roughly corresponds to a <code class="language-plaintext highlighter-rouge">throws</code> clause
in Java. The analogy is even stronger since alongside <code class="language-plaintext highlighter-rouge">CanThrow</code> there is also the following type alias defined in the <code class="language-plaintext highlighter-rouge">scala</code> package:</p>
<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">infix</span> <span class="k">type</span> <span class="kt">canThrow</span><span class="o">[</span><span class="kt">R</span>, <span class="kt">+E</span> <span class="k">&lt;:</span> <span class="kt">Exception</span><span class="o">]</span> <span class="k">=</span> <span class="nc">CanThrow</span><span class="o">[</span><span class="kt">E</span><span class="o">]</span> <span class="o">?=&gt;</span> <span class="n">R</span>
</code></pre></div></div>
<p>That is, <code class="language-plaintext highlighter-rouge">R canThrow E</code> is a context function type that takes an implicit <code class="language-plaintext highlighter-rouge">CanThrow[E]</code> parameter and that returns a value of type <code class="language-plaintext highlighter-rouge">R</code>. Therefore, a method written like this:</p>
<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">m</span><span class="o">(</span><span class="n">x</span><span class="k">:</span> <span class="kt">T</span><span class="o">)(</span><span class="n">using</span> <span class="nc">CanThrow</span><span class="o">[</span><span class="kt">E</span><span class="o">])</span><span class="k">:</span> <span class="kt">U</span>
</code></pre></div></div>
<p>can alternatively be expressed like this:</p>
<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">m</span><span class="o">(</span><span class="n">x</span><span class="k">:</span> <span class="kt">T</span><span class="o">)</span><span class="k">:</span> <span class="kt">U</span> <span class="kt">canThrow</span> <span class="kt">E</span>
</code></pre></div></div>
<p><em>Aside</em>: If we rename <code class="language-plaintext highlighter-rouge">canThrow</code> to <code class="language-plaintext highlighter-rouge">throws</code> we would have a perfect analogy with Java but unfortunately <code class="language-plaintext highlighter-rouge">throws</code> is already taken in Scala 2.13.</p>

<p>The <code class="language-plaintext highlighter-rouge">CanThrow</code>/<code class="language-plaintext highlighter-rouge">canThrow</code> combo essentially propagates the <code class="language-plaintext highlighter-rouge">CanThrow</code> requirement outwards. But where are these abilities created in the first place? That’s in the <code class="language-plaintext highlighter-rouge">try</code> expression. Given a <code class="language-plaintext highlighter-rouge">try</code> like this:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">try</span>
  <span class="n">body</span>
<span class="k">catch</span>
  <span class="k">case</span> <span class="n">ex1</span><span class="k">:</span> <span class="kt">Ex1</span> <span class="o">=&gt;</span> <span class="n">handler1</span>
  <span class="o">...</span>
  <span class="k">case</span> <span class="n">exN</span><span class="k">:</span> <span class="kt">ExN</span> <span class="o">=&gt;</span> <span class="n">handlerN</span>
</code></pre></div></div>
<p>the compiler generates abilities for <code class="language-plaintext highlighter-rouge">CanThrow[Ex1]</code>, …, <code class="language-plaintext highlighter-rouge">CanThrow[ExN]</code> that are in scope as givens in <code class="language-plaintext highlighter-rouge">body</code>. It does this by augmenting the <code class="language-plaintext highlighter-rouge">try</code> roughly as follows:</p>
<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">try</span>
  <span class="n">erased</span> <span class="n">given</span> <span class="nc">CanThrow</span><span class="o">[</span><span class="kt">Ex1</span><span class="o">]</span> <span class="k">=</span> <span class="o">???</span>
  <span class="o">...</span>
  <span class="n">erased</span> <span class="n">given</span> <span class="nc">CanThrow</span><span class="o">[</span><span class="kt">ExN</span><span class="o">]</span> <span class="k">=</span> <span class="o">???</span>
  <span class="n">body</span>
<span class="k">catch</span> <span class="o">...</span>
</code></pre></div></div>
<p>Note that the right-hand side of all givens is <code class="language-plaintext highlighter-rouge">???</code> (undefined). This is OK since
these givens are erased; they will not be executed at runtime.</p>

<h2 id="an-example">An Example</h2>

<p>That’s it. Let’s see it in action in an example. First, add an import</p>
<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">language.experimental.saferExceptions</span>
</code></pre></div></div>
<p>to enable exception checking. Now, define an exception <code class="language-plaintext highlighter-rouge">LimitExceeded</code> and
a function <code class="language-plaintext highlighter-rouge">f</code> like this:</p>
<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">limit</span> <span class="k">=</span> <span class="mi">10</span><span class="n">e9</span>
<span class="k">class</span> <span class="nc">LimitExceeded</span> <span class="k">extends</span> <span class="nc">Exception</span>
<span class="k">def</span> <span class="nf">f</span><span class="o">(</span><span class="n">x</span><span class="k">:</span> <span class="kt">Double</span><span class="o">)</span><span class="k">:</span> <span class="kt">Double</span> <span class="o">=</span>
  <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">limit</span> <span class="n">then</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x</span> <span class="k">else</span> <span class="k">throw</span> <span class="nc">LimitExceeded</span><span class="o">()</span>
</code></pre></div></div>
<p>You’ll get this error message:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>9 |  if x &lt; limit then x * x else throw LimitExceeded()
  |                               ^^^^^^^^^^^^^^^^^^^^^
  |The ability to throw exception LimitExceeded is missing.
  |The ability can be provided by one of the following:
  | - A using clause `(using CanThrow[LimitExceeded])`
  | - A `canThrow` clause in a result type such as `X canThrow LimitExceeded`
  | - an enclosing `try` that catches LimitExceeded
  |
  |The following import might fix the problem:
  |
  |  import unsafeExceptions.canThrowAny
</code></pre></div></div>
<p>As the error message implies, you have to declare that <code class="language-plaintext highlighter-rouge">f</code> needs the ability to throw a <code class="language-plaintext highlighter-rouge">LimitExceeded</code> exception. The most concise way to do so is to add a <code class="language-plaintext highlighter-rouge">canThrow</code> clause:</p>
<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">f</span><span class="o">(</span><span class="n">x</span><span class="k">:</span> <span class="kt">Double</span><span class="o">)</span><span class="k">:</span> <span class="kt">Double</span> <span class="kt">canThrow</span> <span class="kt">LimitExceeded</span> <span class="o">=</span>
  <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">limit</span> <span class="n">then</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x</span> <span class="k">else</span> <span class="k">throw</span> <span class="nc">LimitExceeded</span><span class="o">()</span>
</code></pre></div></div>
<p>Now put a call to <code class="language-plaintext highlighter-rouge">f</code> in a <code class="language-plaintext highlighter-rouge">try</code> that catches <code class="language-plaintext highlighter-rouge">LimitExceeded</code>:</p>
<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@main</span> <span class="k">def</span> <span class="nf">test</span><span class="o">(</span><span class="n">xs</span><span class="k">:</span> <span class="kt">Double*</span><span class="o">)</span> <span class="k">=</span>
  <span class="k">try</span> <span class="nf">println</span><span class="o">(</span><span class="nv">xs</span><span class="o">.</span><span class="py">map</span><span class="o">(</span><span class="n">f</span><span class="o">).</span><span class="py">sum</span><span class="o">)</span>
  <span class="k">catch</span> <span class="k">case</span> <span class="n">ex</span><span class="k">:</span> <span class="kt">LimitExceeded</span> <span class="o">=&gt;</span> <span class="nf">println</span><span class="o">(</span><span class="s">"too large"</span><span class="o">)</span>
</code></pre></div></div>
<p>Run the program with some inputs:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; scala test 1 2 3
14.0
&gt; scala test
0.0
&gt; scala test 1 2 3 100000000000
too large
</code></pre></div></div>
<p>Everything typechecks and works as expected. But wait - we have called <code class="language-plaintext highlighter-rouge">map</code> without any ceremony! How did that work? Here’s how the compiler expands the <code class="language-plaintext highlighter-rouge">test</code> function:</p>
<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// compiler-generated code</span>
<span class="nd">@main</span> <span class="k">def</span> <span class="nf">test</span><span class="o">(</span><span class="n">xs</span><span class="k">:</span> <span class="kt">Double*</span><span class="o">)</span> <span class="k">=</span>
  <span class="k">try</span>
    <span class="n">erased</span> <span class="n">given</span> <span class="n">ctl</span><span class="k">:</span> <span class="kt">CanThrow</span><span class="o">[</span><span class="kt">LimitExceeded</span><span class="o">]</span> <span class="k">=</span> <span class="o">???</span>
    <span class="nf">println</span><span class="o">(</span><span class="nv">xs</span><span class="o">.</span><span class="py">map</span><span class="o">(</span><span class="n">x</span> <span class="k">=&gt;</span> <span class="nf">f</span><span class="o">(</span><span class="n">x</span><span class="o">)(</span><span class="n">using</span> <span class="n">ctl</span><span class="o">)).</span><span class="py">sum</span><span class="o">)</span>
  <span class="k">catch</span> <span class="k">case</span> <span class="n">ex</span><span class="k">:</span> <span class="kt">LimitExceeded</span> <span class="o">=&gt;</span> <span class="nf">println</span><span class="o">(</span><span class="s">"too large"</span><span class="o">)</span>
</code></pre></div></div>
<p>The <code class="language-plaintext highlighter-rouge">CanThrow[LimitExceeded]</code> ability is passed in a synthesized <code class="language-plaintext highlighter-rouge">using</code> clause to <code class="language-plaintext highlighter-rouge">f</code>, since <code class="language-plaintext highlighter-rouge">f</code> requires it. Then the resulting closure is passed to <code class="language-plaintext highlighter-rouge">map</code>. The signature of <code class="language-plaintext highlighter-rouge">map</code> does not have to account for effects. It takes a closure as always, but that
closure may refer to abilities in its free variables. This means that <code class="language-plaintext highlighter-rouge">map</code> is
already effect polymorphic even though we did not change its signature at all.
So the takeaway is that the effects as abilities model naturally provides for effect polymorphism whereas this is something that other approaches struggle with.</p>

<h2 id="gradual-typing-via-imports">Gradual Typing Via Imports</h2>

<p>Another advantage is that the model allows a gradual migration from current unchecked exceptions to safer exceptions. Imagine for a moment that <code class="language-plaintext highlighter-rouge">experimental.saferExceptions</code> is turned on everywhere. There would be lots of code that breaks since functions have not yet been properly annotated with <code class="language-plaintext highlighter-rouge">canThrow</code>. But it’s easy to create an escape hatch that lets us ignore the breakages for a while: simply add the import</p>
<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">scala.unsafeExceptions.canThrowAny</span>
</code></pre></div></div>
<p>This will provide the <code class="language-plaintext highlighter-rouge">CanThrow</code> ability for any exception, and thereby allow
all throws and all other calls, no matter what the current state of <code class="language-plaintext highlighter-rouge">canThrow</code> declarations is. Here’s the
definition of <code class="language-plaintext highlighter-rouge">canThrowAny</code>:</p>
<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="nn">scala</span>
<span class="k">object</span> <span class="nc">unsafeExceptions</span><span class="k">:</span>
  <span class="kt">given</span> <span class="kt">canThrowAny:</span> <span class="kt">CanThrow</span><span class="o">[</span><span class="kt">Exception</span><span class="o">]</span> <span class="k">=</span> <span class="o">???</span>
</code></pre></div></div>
<p>Of course, defining a global ability like this amounts to cheating. But the cheating is useful for gradual typing. The import could be used to migrate existing code, or to
enable more fluid explorations of code without regard for complete exception safety. At the end of these migrations or explorations the import should be removed.</p>

<h2 id="scope-of-the-extension">Scope Of the Extension</h2>

<p>To summarize, the extension for safer exception checking consists of the following elements:</p>

<ul>
  <li>It adds to the standard library the class <code class="language-plaintext highlighter-rouge">scala.CanThrow</code>, the type <code class="language-plaintext highlighter-rouge">scala.canThrow</code>, and the <code class="language-plaintext highlighter-rouge">scala.unsafeExceptions</code> object, as they were described above.</li>
  <li>It augments the type checking of <code class="language-plaintext highlighter-rouge">throw</code> by <em>demanding</em> a <code class="language-plaintext highlighter-rouge">CanThrow</code> ability or the thrown exception.</li>
  <li>It augments the type checking of <code class="language-plaintext highlighter-rouge">try</code> by <em>providing</em> <code class="language-plaintext highlighter-rouge">CanThrow</code> abilities for every caught exception.</li>
</ul>

<p>That’s all. It’s quite remarkable that one can do exception checking in this way without any special additions to the type system. We just need regular givens and context functions. Any runtime overhead is eliminated using <code class="language-plaintext highlighter-rouge">erased</code>.</p>

<h2 id="caveats">Caveats</h2>

<p>Our ability model allows to declare and check the thrown exceptions of first-order code. But as it stands, it does not give us enough mechanism to enforce the <em>absence</em> of
abilities for arguments to higher-order functions. Consider a variant <code class="language-plaintext highlighter-rouge">pureMap</code>
of <code class="language-plaintext highlighter-rouge">map</code> that should enforce that its argument does not throw exceptions or have any other effects (maybe because wants to reorder computations transparently). Right now
we cannot enforce that since the function argument to <code class="language-plaintext highlighter-rouge">pureMap</code> can capture arbitrary
abilities in its free variables without them showing up in its type. One possible way to
address this would be to introduce a pure function type (maybe written <code class="language-plaintext highlighter-rouge">A -&gt; B</code>). Pure functions are not allowed to close over abilities. Then <code class="language-plaintext highlighter-rouge">pureMap</code> could be written
like this:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  def pureMap(f: A -&gt; B): List[B]
</code></pre></div></div>
<p>Another area where the lack of purity requirements shows up is when abilities escape from bounded scopes. Consider the following function</p>
<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">escaped</span><span class="o">(</span><span class="n">xs</span><span class="k">:</span> <span class="kt">Double*</span><span class="o">)</span><span class="k">:</span> <span class="o">()</span> <span class="o">=&gt;</span> <span class="nc">Int</span> <span class="k">=</span>
  <span class="nf">try</span> <span class="o">()</span> <span class="k">=&gt;</span> <span class="nv">xs</span><span class="o">.</span><span class="py">map</span><span class="o">(</span><span class="n">f</span><span class="o">).</span><span class="py">sum</span>
  <span class="k">catch</span> <span class="k">case</span> <span class="n">ex</span><span class="k">:</span> <span class="kt">LimitExceeded</span> <span class="o">=&gt;</span> <span class="o">-</span><span class="mi">1</span>
</code></pre></div></div>
<p>With the system presented here, this function typechecks, with expansion</p>
<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// compiler-generated code</span>
<span class="k">def</span> <span class="nf">escaped</span><span class="o">(</span><span class="n">xs</span><span class="k">:</span> <span class="kt">Double*</span><span class="o">)</span><span class="k">:</span> <span class="o">()</span> <span class="o">=&gt;</span> <span class="nc">Int</span> <span class="k">=</span>
  <span class="k">try</span>
    <span class="n">given</span> <span class="n">ctl</span><span class="k">:</span> <span class="kt">CanThrow</span><span class="o">[</span><span class="kt">LimitExceeded</span><span class="o">]</span> <span class="k">=</span> <span class="o">???</span>
    <span class="o">()</span> <span class="k">=&gt;</span> <span class="nv">xs</span><span class="o">.</span><span class="py">map</span><span class="o">(</span><span class="n">x</span> <span class="k">=&gt;</span> <span class="nf">f</span><span class="o">(</span><span class="n">x</span><span class="o">)(</span><span class="n">using</span> <span class="n">ctl</span><span class="o">)).</span><span class="py">sum</span>
  <span class="k">catch</span> <span class="k">case</span> <span class="n">ex</span><span class="k">:</span> <span class="kt">LimitExceeded</span> <span class="o">=&gt;</span> <span class="o">-</span><span class="mi">1</span>
</code></pre></div></div>
<p>But if you try to call <code class="language-plaintext highlighter-rouge">escaped</code> like this</p>
<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">g</span> <span class="k">=</span> <span class="nf">escaped</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">1000000000</span><span class="o">)</span>
<span class="nf">g</span><span class="o">()</span>
</code></pre></div></div>
<p>the result will be a <code class="language-plaintext highlighter-rouge">LimitExceeded</code> exception thrown at the second line where <code class="language-plaintext highlighter-rouge">g</code> is called. What’s missing is that <code class="language-plaintext highlighter-rouge">try</code> should enforce that the abilities it generates do not escape as free variables in the result of its body. It makes sense to describe such scoped effects as <em>ephemeral abilities</em> - they have lifetimes that cannot be extended to delayed code in a lambda.</p>

<h1 id="outlook">Outlook</h1>

<p>We are working on a new class of type system that supports ephemeral abilities by tracking the free variables of values. Once that research matures, it will hopefully be possible to augment the language so that we can enforce the missing properties.</p>

<p>And it would have many other applications besides: Exceptions are a special case of <em>algebraic effects</em>, which has been a very active research area over the last 20 years and is finding its way into programming languages (e.g. Koka, Eff, Multicore OCaml, Unison). In fact, algebraic effects have been characterized as being equivalent to exceptions with an additional <em>resume</em> operation. The techniques developed here for exceptions can probably be generalized to other classes of algebraic effects.</p>

<p>But even without these additional mechanisms, exception checking is already useful as it is. It gives a clear path forward to make code that uses exceptions safer, better documented, and easier to refactor. The only loophole arises for scoped abilities - here we have to verify manually that these abilities do not escape. Specifically, a <code class="language-plaintext highlighter-rouge">try</code> always has to be placed in the same computation stage as the throws that it enables.</p>

<p>Put another way: If the status quo is 0% static checking since 100% is too painful, then an alternative that gives you 95% static checking with great ergonomics looks like a win. And we might still get to 100% in the future.</p>


				</div>

				<div class="content-contributors">
    <h3>Contributors to this page:</h3>
    <div id="contributors" class="contributors-container"></div>
</div>

			</div>
		</div>

		<!-- TOC -->
		<div class="content-nav">
	<div class="inner-box sidebar-toc-wrapper" style="">
		<h5 class="contents">Contents</h5>
		<div class="inner-toc" id="sidebar-toc">
      <div id="toc"></div>
      
		</div>
		<hr>
		<div class="help-us"><a href="https://github.com/scala/docs.scala-lang/blob/main/_scala3-reference/experimental/canthrow.md"><i class="fa fa-pencil" aria-hidden="true"></i> Problem with this page?<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Please help us fix it!</a></div>
	</div>
</div>

	</div>
</section>


</main>

<footer id="site-footer">
    <div class="wrap">
      <div class="site-footer-top">
        
          <ul class="documentation">
            <li><h3>Documentation</h3></li>
            
              <li><a href="/docs.scala-lang/getting-started.html">Getting Started</a></li>
            
              <li><a href="https://www.scala-lang.org/api/current/index.html">API</a></li>
            
              <li><a href="/docs.scala-lang/overviews">Overviews/Guides</a></li>
            
              <li><a href="http://scala-lang.org/files/archive/spec/2.13/">Language Specification</a></li>
            
          </ul>
        
          <ul class="download">
            <li><h3>Download</h3></li>
            
              <li><a href="http://scala-lang.org/download/">Current Version</a></li>
            
              <li><a href="http://scala-lang.org/download/all.html">All versions</a></li>
            
          </ul>
        
          <ul class="community">
            <li><h3>Community</h3></li>
            
              <li><a href="http://scala-lang.org/community/">Community</a></li>
            
              <li><a href="http://scala-lang.org/community/index.html#mailing-lists">Mailing Lists</a></li>
            
              <li><a href="http://scala-lang.org/community/index.html#chat-rooms">Chat Rooms & More</a></li>
            
              <li><a href="http://scala-lang.org/community/index.html#community-libraries-and-tools">Libraries and Tools</a></li>
            
              <li><a href="http://scala.epfl.ch/">The Scala Center</a></li>
            
          </ul>
        
          <ul class="contribute">
            <li><h3>Contribute</h3></li>
            
              <li><a href="http://scala-lang.org/contribute/">How to help</a></li>
            
              <li><a href="http://scala-lang.org/contribute/bug-reporting-guide.html">Report an Issue</a></li>
            
          </ul>
        
          <ul class="scala">
            <li><h3>Scala</h3></li>
            
              <li><a href="http://scala-lang.org/blog/">Blog</a></li>
            
              <li><a href="http://scala-lang.org/conduct/">Code of Conduct</a></li>
            
              <li><a href="http://scala-lang.org/license/">License</a></li>
            
          </ul>
        
          <ul class="social">
            <li><h3>Social</h3></li>
            
              <li><a href="https://github.com/scala/scala">GitHub</a></li>
            
              <li><a href="https://twitter.com/scala_lang">Twitter</a></li>
            
          </ul>
        
      </div>
      <div class="site-footer-bottom">
        <p></p>
        <img src="/docs.scala-lang/resources/img/frontpage/scala-logo-white.png" alt="">
      </div>
    </div>
    <a class="back-to-top in" href="#" id="scroll-to-top-btn">
      <i class="fa fa-angle-up"></i>
    </a>
</footer>

<!-- jquery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js" integrity="sha384-3ceskX3iaEnIogmQchP8opvBy3Mi7Ce34nWjpBIwVTHfGYWQS9jwHDVRnpKKHJg7" crossorigin="anonymous"></script>
<script>(window.jQuery) || document.write('<script src="/docs.scala-lang/scripts/jquery-3.1.1.min.js"><\/script>');</script>
<script src="/docs.scala-lang/resources/js/vendor/jquery.autocomplete.js" type="text/javascript"></script>



<script src="/docs.scala-lang/scripts/searchbar.js" type="text/javascript"></script>
<link rel="stylesheet" href="/docs.scala-lang/scripts/my.css" type="text/css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.9.0/css/all.min.css">

<!-- moment js -->
<script src="/docs.scala-lang/resources/js/vendor/moment.min.js" type="text/javascript"></script>

<!-- tweet feed -->
<script src="/docs.scala-lang/resources/js/tweetMachine-update.js" type="text/javascript"></script>

<!-- prettify js -->
<script src="/docs.scala-lang/resources/js/vendor/prettify/prettify.js" type="text/javascript"></script>
<script src="/docs.scala-lang/resources/js/vendor/prettify/lang-scala.js" type="text/javascript"></script>

<!-- unslider js -->
<script src="/docs.scala-lang/resources/js/vendor/unslider.js" type="text/javascript"></script>

<!-- Highlight -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/highlight.min.js" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/languages/scala.min.js" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/languages/java.min.js" type="text/javascript"></script>

<!-- CodeMirror -->
<script src="/docs.scala-lang/resources/js/vendor/codemirror/codemirror.js" type="text/javascript"></script>
<script src="/docs.scala-lang/resources/js/vendor/codemirror/clike.js" type="text/javascript"></script>

<!-- TOC -->
<script src="/docs.scala-lang/resources/js/vendor/toc.js" type="text/javascript"></script>

<!-- Blog search -->
<script src="/docs.scala-lang/resources/js/vendor/jekyll.search.min.js" type="text/javascript"></script>

<!-- Custom JavaScript -->
<script src="/docs.scala-lang/resources/js/functions.js" type="text/javascript"></script>



<!-- Alogolia search for doc -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
<script type="text/javascript">
if ($("#doc-search-bar").length) {
  docsearch({
    apiKey: 'fbc439670f5d4e3730cdcb715c359391',
    indexName: 'scala-lang',
    inputSelector: '#doc-search-bar',
    algoliaOptions: { 'facetFilters': ["language:en"] },
    debug: false // Set debug to true if you want to inspect the dropdown
  });
}
</script>
</body>

</html>

